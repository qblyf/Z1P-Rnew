# 修复红米 15R 型号提取问题

## 问题描述

**输入**: `红米15R 4+128星岩黑`  
**期望匹配**: `红米 15R 全网通5G版 4GB+128GB 星岩黑`  
**实际结果**: 匹配失败

### 错误日志

```
[精确匹配] 统计: 检查132个, 过滤11个, 品牌不匹配0个, 型号不匹配29个
```

品牌匹配成功（0个品牌不匹配），但有29个型号不匹配，说明型号提取有问题。

## 根本原因

问题出在 `extractModelFromSPU` 函数的颜色移除逻辑：

### 旧代码

```typescript
// 移除颜色信息（简单处理，移除常见颜色词）
const colors = ['黑', '白', '蓝', '红', '绿', '紫', '粉', '金', '银', '灰', '棕', '青', '橙', '黄'];
for (const color of colors) {
  normalized = normalized.replace(new RegExp(`${color}[\\u4e00-\\u9fa5]*`, 'g'), ' ');
}
```

### 问题分析

对于 SPU 名称 `"红米 15R 全网通5G版 4GB+128GB 星岩黑"`：

1. 移除品牌后: `"15r 全网通5g版 4gb+128gb 星岩黑"`
2. 移除描述词后: `"15r     4 +128  星岩黑"`
3. 移除容量后: `"15r        星岩黑"`
4. **移除颜色后**: `"15r        星岩 "` ❌

旧的正则表达式 `${color}[\\u4e00-\\u9fa5]*` 只匹配：
- 颜色字 + 后面的中文字符

对于 "星岩黑"：
- 只匹配到 "黑"（没有后面的中文字符）
- 留下了 "星岩"

最终提取的型号是 `"15r星岩"` 而不是 `"15r"`，导致匹配失败。

## 解决方案

改进颜色移除正则表达式，同时移除颜色词**前后**的中文字符：

```typescript
// 移除颜色信息（改进：移除颜色词及其前后的中文字符）
// 例如："星岩黑" -> 全部移除，而不是只移除 "黑"
const colors = ['黑', '白', '蓝', '红', '绿', '紫', '粉', '金', '银', '灰', '棕', '青', '橙', '黄'];
for (const color of colors) {
  // 匹配：颜色词前面的中文字符 + 颜色词 + 颜色词后面的中文字符
  normalized = normalized.replace(new RegExp(`[\\u4e00-\\u9fa5]*${color}[\\u4e00-\\u9fa5]*`, 'g'), ' ');
}
```

### 新的处理流程

对于 SPU 名称 `"红米 15R 全网通5G版 4GB+128GB 星岩黑"`：

1. 移除品牌后: `"15r 全网通5g版 4gb+128gb 星岩黑"`
2. 移除描述词后: `"15r     4 +128  星岩黑"`
3. 移除容量后: `"15r        星岩黑"`
4. **移除颜色后**: `"15r         "` ✅
5. 清理空格后: `"15r"` ✅

现在正确提取出型号 `"15r"`，与输入的型号匹配成功！

## 测试验证

### 测试用例

```typescript
// 输入
extractModel('红米15R 4+128星岩黑', '红米') 
// => "15r" ✅

// SPU（完整名称）
extractModelFromSPU('红米 15R 全网通5G版 4GB+128GB 星岩黑', '红米')
// => "15r" ✅ (修复前: "15r星岩" ❌)

// SPU（简化名称）
extractModelFromSPU('红米 15R', '红米')
// => "15r" ✅
```

### 匹配结果

```
输入型号: "15r"
SPU型号1: "15r"  ✅ (修复前: "15r星岩" ❌)
SPU型号2: "15r"  ✅

输入 vs SPU1: ✓ 匹配 (修复前: ✗ 不匹配)
输入 vs SPU2: ✓ 匹配
```

## 影响范围

这个修复影响所有使用 `extractModelFromSPU` 函数的场景：

1. **动态型号索引构建** (`buildSPUIndex`)
   - 从实际 SPU 数据中提取型号
   - 构建型号索引用于快速匹配

2. **所有包含复杂颜色名称的 SPU**
   - 例如：星岩黑、天空蓝、玫瑰金、琥珀棕等
   - 修复前：这些颜色可能只被部分移除
   - 修复后：完整移除整个颜色词组

## 相关文件

- `Z1P-Rnew/utils/smartMatcher.ts` - 主要修复文件
- `Z1P-Rnew/scripts/test-redmi-15r-issue.ts` - 测试脚本

## 提交信息

```
fix: 改进 extractModelFromSPU 的颜色移除逻辑

修复红米 15R 匹配失败问题。

问题：
- 输入 "红米15R 4+128星岩黑" 无法匹配 "红米 15R 全网通5G版 4GB+128GB 星岩黑"
- 原因：颜色移除正则只移除颜色词后面的中文，导致 "星岩黑" 只移除 "黑"，留下 "星岩"

修复：
- 改进正则表达式，同时移除颜色词前后的中文字符
- 例如："星岩黑" 现在会完整移除，而不是只移除 "黑"

影响：
- 所有包含复杂颜色名称的 SPU 型号提取更准确
- 动态型号索引构建更可靠
```
