# 实施计划: 智能匹配功能优化

## 概述

本实施计划将智能匹配系统的优化分解为离散的编码步骤。主要目标是将型号提取从匹配阶段前移到预处理阶段，并实现基于预提取数据的高效精确匹配。

## 任务列表

- [x] 1. 扩展SPU数据结构和类型定义
  - 在`types.ts`中定义`EnhancedSPUData`接口
  - 添加新字段：`extractedBrand`、`extractedModel`、`normalizedModel`、`simplicity`、`preprocessedAt`
  - 确保向后兼容现有的`SPUData`接口
  - _需求: 2.1.1, 2.1.2, 2.1.4_

- [ ] 2. 实现DataPreparationService预处理方法
  - [x] 2.1 实现品牌提取方法
    - 创建`extractBrand(spu: SPUData): string | null`方法
    - 优先使用`spu.brand`字段，否则从`name`中提取
    - 支持中文和拼音品牌名
    - _需求: 2.1.1_
  
  - [ ]* 2.2 编写品牌提取的属性测试
    - **属性 1: 品牌提取一致性**
    - **验证需求: 2.1.1**
  
  - [x] 2.3 实现型号提取和标准化方法
    - 创建`extractModel(spu: SPUData, brand: string | null): string | null`方法
    - 创建`normalizeModelForMatching(model: string): string`方法
    - 标准化规则：小写 + 移除空格和特殊字符
    - _需求: 2.1.2, 2.3.2_
  
  - [ ]* 2.4 编写型号标准化的属性测试
    - **属性 2: 型号标准化幂等性**
    - **属性 5: 型号标准化一致性**
    - **验证需求: 2.1.2, 2.3.2**
  
  - [x] 2.5 实现精简度计算方法
    - 创建`calculateSimplicity(spu: SPUData, brand: string | null, model: string | null): number`方法
    - 实现公式：`name.length - brand.length - model.length - specs.length`
    - 从`skuIDs`中提取规格信息长度
    - _需求: 2.1.4, 2.5.4_
  
  - [ ]* 2.6 编写精简度计算的属性测试
    - **属性 4: 精简度计算正确性**
    - **属性 22: 精简度单调性**
    - **验证需求: 2.1.4, 2.5.4**
  
  - [x] 2.7 实现完整的预处理流程
    - 创建`preprocessSPUs(spuList: SPUData[]): EnhancedSPUData[]`方法
    - 遍历所有SPU，提取品牌、型号、精简度
    - 处理错误情况（缺少字段、提取失败）
    - 记录统计信息和警告日志
    - _需求: 2.1.1, 2.1.2, 2.1.4, 2.1.5_
  
  - [ ]* 2.8 编写预处理流程的单元测试
    - 测试正常情况
    - 测试边缘情况（空输入、缺少字段）
    - 测试错误处理
    - _需求: 2.1.1, 2.1.2, 2.1.4_


- [x] 3. 检查点 - 确保预处理功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 4. 修改ExactMatcher使用预提取数据
  - [x] 4.1 更新findMatches方法签名
    - 修改候选SPU参数类型为`EnhancedSPUData[]`
    - 移除动态提取相关的options参数
    - _需求: 2.4.1, 2.4.2, 2.4.3_
  
  - [x] 4.2 修改品牌和型号匹配逻辑
    - 直接使用`spu.extractedBrand`而不是动态提取
    - 直接使用`spu.normalizedModel`进行比较
    - 移除`normalizeForComparison`调用（已在预处理完成）
    - _需求: 2.4.1, 2.4.2_
  
  - [ ]* 4.3 编写品牌和型号匹配的属性测试
    - **属性 16: 品牌匹配大小写不敏感**
    - **属性 17: 型号匹配标准化后精确比较**
    - **验证需求: 2.4.1, 2.4.2**
  
  - [x] 4.4 实现基于精简度的优先级排序
    - 修改排序逻辑：分数 > 版本类型 > 精简度
    - 使用`spu.simplicity`进行第三级排序
    - _需求: 2.5.1, 2.5.2, 2.5.3_
  
  - [ ]* 4.5 编写优先级排序的属性测试
    - **属性 21: 多级排序正确性**
    - **验证需求: 2.5.1, 2.5.2, 2.5.3**
  
  - [ ]* 4.6 编写匹配分数计算的属性测试
    - **属性 20: 匹配分数计算正确性**
    - **验证需求: 2.4.5**
  
  - [ ]* 4.7 编写单元测试验证匹配逻辑
    - 测试品牌匹配
    - 测试型号匹配
    - 测试版本匹配可选性
    - 测试优先级排序
    - _需求: 2.4.1, 2.4.2, 2.4.4, 2.5.1, 2.5.2, 2.5.3_

- [x] 5. 检查点 - 确保匹配功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 6. 更新MatchingOrchestrator集成预处理
  - [x] 6.1 修改initialize方法
    - 在初始化时调用`dataPreparation.preprocessSPUs(spuList)`
    - 将增强的SPU数据传递给索引构建方法
    - 存储增强的SPU列表供匹配使用
    - _需求: 2.1.1, 2.1.2, 2.1.4_
  
  - [x] 6.2 更新索引构建调用
    - 确保`buildBrandIndex`、`buildModelIndex`、`buildSpecIndex`使用增强的SPU数据
    - 验证索引构建正常工作
    - _需求: 2.1.2, 2.4.3_
  
  - [x] 6.3 更新匹配流程
    - 确保`ExactMatcher`接收增强的SPU数据
    - 保持现有API接口不变
    - _需求: 2.4.1, 2.4.2_
  
  - [ ]* 6.4 编写集成测试
    - 测试完整的预处理到匹配流程
    - 测试与现有组件的集成
    - 验证API接口向后兼容
    - _需求: 2.1.1, 2.1.2, 2.4.1, 2.4.2_


- [ ] 7. 验证输入处理功能
  - [x] 7.1 验证PreprocessingService清洗功能
    - 确认演示机标记移除正常工作
    - 确认礼盒标记移除正常工作
    - 确认配件标记移除正常工作
    - _需求: 2.2.1_
  
  - [ ]* 7.2 编写清洗操作的属性测试
    - **属性 6: 清洗操作保留核心信息**
    - **验证需求: 2.2.1**
  
  - [x] 7.3 验证拼写纠错功能
    - 确认配置文件中的拼写错误映射正常工作
    - 测试常见拼写错误（如"雾松蓝"→"雾凇蓝"）
    - _需求: 2.2.2_
  
  - [ ]* 7.4 编写拼写纠错的属性测试
    - **属性 7: 拼写纠错映射正确性**
    - **验证需求: 2.2.2**
  
  - [x] 7.5 验证缩写展开功能
    - 确认配置文件中的缩写映射正常工作
    - 测试常见缩写（如"GT5"→"Watch GT 5"）
    - _需求: 2.2.3_
  
  - [ ]* 7.6 编写缩写展开的属性测试
    - **属性 8: 缩写展开映射正确性**
    - **验证需求: 2.2.3**
  
  - [x] 7.7 验证品牌别名功能
    - 确认配置文件中的品牌别名映射正常工作
    - 测试常见品牌别名（如"HUAWEI"→"华为"）
    - _需求: 2.2.4_
  
  - [ ]* 7.8 编写品牌别名的属性测试
    - **属性 9: 品牌别名映射正确性**
    - **验证需求: 2.2.4**
  
  - [x] 7.9 验证容量标准化功能
    - 确认各种容量格式都能标准化为统一格式
    - 测试"8GB+256GB"、"8G+256G"、"8+256"等格式
    - _需求: 2.2.5_
  
  - [ ]* 7.10 编写容量标准化的属性测试
    - **属性 10: 容量标准化一致性**
    - **验证需求: 2.2.5**

- [x] 8. 检查点 - 确保输入处理功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 9. 验证信息提取功能
  - [x] 9.1 验证InfoExtractor提取功能
    - 确认品牌提取正常工作（中文、拼音）
    - 确认型号提取正常工作
    - 确认颜色提取正常工作
    - 确认容量提取正常工作
    - 确认版本提取正常工作
    - _需求: 2.3.1, 2.3.2, 2.3.3, 2.3.4, 2.3.5_
  
  - [ ]* 9.2 编写置信度评分的属性测试
    - **属性 11: 品牌提取置信度有效性**
    - **属性 12: 型号提取置信度有效性**
    - **属性 13: 颜色提取置信度有效性**
    - **属性 14: 容量提取置信度有效性**
    - **属性 15: 版本提取置信度有效性**
    - **验证需求: 2.3.1, 2.3.2, 2.3.3, 2.3.4, 2.3.5, 2.3.6**
  
  - [ ]* 9.3 编写信息提取的单元测试
    - 测试各种输入格式
    - 测试边缘情况
    - 测试错误处理
    - _需求: 2.3.1, 2.3.2, 2.3.3, 2.3.4, 2.3.5_


- [ ] 10. 验证品牌索引功能
  - [x] 10.1 验证品牌索引构建
    - 确认品牌索引正确构建
    - 确认支持中文和拼音双向索引
    - 确认索引统计信息正确
    - _需求: 2.1.2, 2.4.3_
  
  - [ ]* 10.2 编写品牌索引的属性测试
    - **属性 18: 品牌索引过滤正确性**
    - **验证需求: 2.4.3**
  
  - [ ]* 10.3 编写品牌索引的单元测试
    - 测试索引构建
    - 测试索引查询
    - 测试中文和拼音查询
    - _需求: 2.1.2, 2.4.3_

- [ ] 11. 验证规格索引功能
  - [x] 11.1 验证规格索引构建
    - 确认从skuIDs中提取颜色、容量、版本信息
    - 确认规格索引正确构建
    - 确认频率排序列表正确
    - _需求: 2.1.3_
  
  - [ ]* 11.2 编写规格索引的属性测试
    - **属性 3: 规格索引完整性**
    - **验证需求: 2.1.3**
  
  - [ ]* 11.3 编写规格索引的单元测试
    - 测试索引构建
    - 测试频率统计
    - 测试规格标准化
    - _需求: 2.1.3_

- [x] 12. 检查点 - 确保索引功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 13. 验证SKU匹配功能
  - [x] 13.1 验证SKUMatcher多维度匹配
    - 确认颜色、容量、版本三个维度都被考虑
    - 确认产品类型权重正确应用
    - 确认从skuIDs结构化数据中提取规格
    - _需求: 2.6.1, 2.6.2, 2.6.3_
  
  - [ ]* 13.2 编写SKU匹配的属性测试
    - **属性 23: SKU多维度匹配完整性**
    - **属性 24: SKU分数计算正确性**
    - **属性 25: 最佳SKU选择正确性**
    - **验证需求: 2.6.1, 2.6.2, 2.6.4, 2.6.5**
  
  - [ ]* 13.3 编写SKU匹配的单元测试
    - 测试多维度匹配
    - 测试权重应用
    - 测试分数计算
    - 测试最佳SKU选择
    - _需求: 2.6.1, 2.6.2, 2.6.4, 2.6.5_

- [ ] 14. 验证模糊匹配功能
  - [x] 14.1 验证FuzzyMatcher触发条件
    - 确认只在精确匹配失败或分数<0.99时触发
    - 确认品牌仍然严格匹配
    - _需求: 2.7.1, 2.7.2_
  
  - [x] 14.2 验证模糊匹配算法
    - 确认型号相似度计算正确
    - 确认相似度阈值≥0.5
    - 确认分数计算公式正确
    - 确认matchType标注为"fuzzy"
    - _需求: 2.7.3, 2.7.4, 2.7.5_
  
  - [ ]* 14.3 编写模糊匹配的属性测试
    - **属性 26: 模糊匹配触发条件**
    - **属性 27: 模糊匹配品牌严格性**
    - **属性 28: 模糊匹配相似度阈值**
    - **属性 29: 模糊匹配分数计算正确性**
    - **属性 30: 模糊匹配类型标注**
    - **验证需求: 2.7.1, 2.7.2, 2.7.3, 2.7.4, 2.7.5**
  
  - [ ]* 14.4 编写模糊匹配的单元测试
    - 测试触发条件
    - 测试品牌匹配
    - 测试相似度计算
    - 测试分数计算
    - 测试类型标注
    - _需求: 2.7.1, 2.7.2, 2.7.3, 2.7.4, 2.7.5_


- [x] 15. 检查点 - 确保所有匹配功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 16. 性能测试和优化
  - [x] 16.1 运行预处理性能测试
    - 测试10000个SPU的预处理时间
    - 验证耗时 < 5秒
    - 记录性能指标
    - _需求: 4.1.1_
  
  - [x] 16.2 运行匹配性能测试
    - 测试单次匹配时间
    - 验证耗时 < 100ms
    - 记录平均耗时、P95、P99
    - _需求: 4.1.2_
  
  - [x] 16.3 运行批量匹配性能测试
    - 测试100条记录的批量匹配时间
    - 验证耗时 < 10秒
    - 记录性能指标
    - _需求: 4.1.3_
  
  - [x] 16.4 运行内存使用测试
    - 监控预处理和匹配过程的内存使用
    - 验证内存占用 < 500MB
    - 记录峰值内存和平均内存
    - _需求: 4.1.4_
  
  - [x] 16.5 性能优化（如果需要）
    - 如果性能测试未达标，进行优化
    - 优化预处理逻辑
    - 优化匹配逻辑
    - 优化内存使用
    - _需求: 4.1.1, 4.1.2, 4.1.3, 4.1.4_

- [ ] 17. 准确性测试
  - [x] 17.1 运行精确匹配准确率测试
    - 使用测试数据集测试精确匹配准确率
    - 验证准确率 ≥ 95%
    - 记录准确率指标
    - _需求: 4.2.1_
  
  - [x] 17.2 运行整体匹配率测试
    - 测试整体匹配率（包括模糊匹配）
    - 验证匹配率 ≥ 90%
    - 记录匹配率指标
    - _需求: 4.2.2_
  
  - [x] 17.3 运行误匹配率测试
    - 测试误匹配率
    - 验证误匹配率 < 2%
    - 记录误匹配案例
    - _需求: 4.2.3_
  
  - [x] 17.4 准确性优化（如果需要）
    - 如果准确性测试未达标，进行优化
    - 调整匹配算法
    - 调整分数计算
    - 调整优先级排序
    - _需求: 4.2.1, 4.2.2, 4.2.3_

- [x] 18. 最终检查点 - 确保所有功能和性能达标
  - 确保所有测试通过，所有性能和准确性指标达标，如有问题请询问用户。

- [x] 19. 文档和代码清理
  - [x] 19.1 更新代码注释
    - 为新增的字段和方法添加详细注释
    - 更新现有注释以反映变更
    - _需求: 4.3.2_
  
  - [x] 19.2 更新API文档
    - 更新`EnhancedSPUData`接口文档
    - 更新`DataPreparationService`方法文档
    - 更新`ExactMatcher`方法文档
    - _需求: 4.3.2_
  
  - [x] 19.3 添加使用示例
    - 添加预处理使用示例
    - 添加匹配使用示例
    - 添加完整流程示例
    - _需求: 4.3.2_
  
  - [x] 19.4 代码清理
    - 移除未使用的代码
    - 移除调试日志
    - 格式化代码
    - _需求: 4.3.1_

- [x] 20. 最终验收
  - 运行所有测试套件
  - 验证所有功能正常工作
  - 验证性能和准确性指标达标
  - 准备部署

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求编号，便于追溯
- 检查点任务确保增量验证
- 属性测试使用fast-check库，每个测试运行100次迭代
- 单元测试专注于特定示例和边缘情况
