# 实现计划：智能匹配算法优化

## 概述

本实现计划将智能匹配算法优化分解为离散的编码步骤。优化将在现有的 `SmartMatcher` 类和 `MatchingService` 类基础上进行，增强其标准化、提取和匹配能力。

## 任务

- [ ] 1. 实现 Space_Handler（空格处理器）
  - 创建 `SpaceHandler` 类，实现型号名称空格标准化
  - 实现 `normalizeSpaces()` 方法，处理品牌后和型号后缀前的空格
  - 实现品牌识别逻辑（IQOO、OPPO、VIVO、Hi等）
  - 实现型号后缀识别逻辑（Pro、Max、Mini、Plus、Ultra、SE、Air、Turbo等）
  - 处理特殊情况（Ace系列、MateBook系列）
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 1.1 编写属性测试：空格标准化幂等性
  - **属性 1：空格标准化幂等性**
  - **验证：需求 1.1, 1.2, 1.3**
  - 生成随机型号名称（有/无空格、多余空格）
  - 验证多次标准化产生相同结果
  - 标签：`Feature: smart-match-optimization, Property 1: 空格标准化幂等性`

- [ ] 1.2 编写属性测试：型号后缀识别完整性
  - **属性 2：型号后缀识别完整性**
  - **验证：需求 1.4**
  - 生成包含常见后缀的型号名称
  - 验证后缀前空格被正确添加
  - 标签：`Feature: smart-match-optimization, Property 2: 型号后缀识别完整性`

- [ ] 1.3 编写属性测试：品牌型号分隔
  - **属性 3：品牌型号分隔**
  - **验证：需求 1.5**
  - 生成品牌+型号代码组合
  - 验证品牌与型号之间空格被正确添加
  - 标签：`Feature: smart-match-optimization, Property 3: 品牌型号分隔`

- [ ] 2. 实现 Watch_Recognizer（手表识别器）
  - 创建 `WatchRecognizer` 类，专门处理手表类产品
  - 实现 `isWatchProduct()` 方法，识别手表产品
  - 实现 `extractWatchModelCode()` 方法，提取型号代码（如WA2456C）
  - 实现 `extractWatchAttributes()` 方法，提取手表属性
  - 实现 `normalizeWatchAttributes()` 方法，标准化属性顺序
  - 定义 `WatchAttributes` 接口
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x]* 2.1 编写属性测试：手表产品识别
  - **属性 4：手表产品识别**
  - **验证：需求 2.1**
  - 生成包含手表关键词的产品名称
  - 验证被正确识别为手表类型
  - 标签：`Feature: smart-match-optimization, Property 4: 手表产品识别`

- [x]* 2.2 编写属性测试：手表型号代码提取
  - **属性 5：手表型号代码提取**
  - **验证：需求 2.2**
  - 生成包含括号内型号代码的手表名称
  - 验证型号代码被正确提取
  - 标签：`Feature: smart-match-optimization, Property 5: 手表型号代码提取`

- [x]* 2.3 编写属性测试：手表属性顺序不变性
  - **属性 6：手表属性顺序不变性**
  - **验证：需求 2.3, 2.4, 2.5**
  - 生成不同属性顺序的手表名称
  - 验证标准化后按固定顺序排列
  - 标签：`Feature: smart-match-optimization, Property 6: 手表属性顺序不变性`

- [ ] 3. 实现 Version_Extractor（版本提取器）
  - 创建 `VersionExtractor` 类，提取产品版本标识
  - 实现 `extractVersion()` 方法，识别版本标识词汇
  - 实现 `versionsMatch()` 方法，判断版本是否匹配
  - 支持常见版本标识：活力版、标准版、青春版、至尊版、竞速版、极速版、全网通5G版等
  - _需求: 4.1, 4.3_

- [x]* 3.1 编写属性测试：版本标识提取
  - **属性 9：版本标识提取**
  - **验证：需求 4.1, 4.3**
  - 生成包含版本标识词汇的产品名称
  - 验证版本标识被正确提取
  - 标签：`Feature: smart-match-optimization, Property 9: 版本标识提取`

- [ ] 4. 实现 Model_Disambiguator（型号消歧器）
  - 创建 `ModelDisambiguator` 类，区分相似型号
  - 实现 `extractFullModel()` 方法，提取完整型号（包括后缀）
  - 实现 `modelsExactMatch()` 方法，判断型号是否完全匹配
  - 实现 `calculateModelMatchScore()` 方法，计算型号匹配分数
  - 将后缀（mini、Plus等）视为型号的一部分
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x]* 4.1 编写属性测试：型号精确匹配排他性
  - **属性 7：型号精确匹配排他性**
  - **验证：需求 3.1, 3.2, 3.4**
  - 生成完整型号名称
  - 验证不匹配包含额外后缀的型号
  - 标签：`Feature: smart-match-optimization, Property 7: 型号精确匹配排他性`

- [x]* 4.2 编写属性测试：型号匹配分数单调性
  - **属性 8：型号匹配分数单调性**
  - **验证：需求 3.3, 3.5**
  - 生成型号对（完全匹配、部分匹配、不匹配）
  - 验证分数单调性：完全匹配 > 部分匹配 > 不匹配
  - 标签：`Feature: smart-match-optimization, Property 8: 型号匹配分数单调性`

- [ ] 5. 检查点 - 确保所有组件测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 6. 增强 SmartMatcher 类
  - [x] 6.1 集成 Space_Handler
    - 在 `SmartMatcher` 中添加 `spaceHandler` 实例
    - 在 `normalizeSpaces()` 方法中使用 `SpaceHandler`
    - 更新 `deepNormalize()` 方法，先调用空格标准化
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_
  
  - [x] 6.2 集成 Watch_Recognizer
    - 在 `SmartMatcher` 中添加 `watchRecognizer` 实例
    - 在 `extractProductType()` 中使用手表识别器
    - 在匹配逻辑中特殊处理手表产品
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [x] 6.3 集成 Version_Extractor
    - 在 `SmartMatcher` 中添加 `versionExtractor` 实例
    - 在 `extractKeywords()` 中提取版本标识
    - 在相似度计算中考虑版本匹配
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_
  
  - [x] 6.4 集成 Model_Disambiguator
    - 在 `SmartMatcher` 中添加 `modelDisambiguator` 实例
    - 在 `extractModel()` 中使用型号消歧器
    - 在相似度计算中使用型号匹配分数
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x]* 6.5 编写属性测试：版本匹配优先级
  - **属性 10：版本匹配优先级**
  - **验证：需求 4.2, 4.4, 4.5**
  - 生成包含版本标识的输入和多个候选SKU
  - 验证版本匹配的候选项获得更高分数
  - 标签：`Feature: smart-match-optimization, Property 10: 版本匹配优先级`

- [ ] 7. 增强颜色匹配逻辑
  - 改进 `extractColor()` 方法，使用动态颜色列表
  - 实现颜色同义词映射（雾凇/雾松等）
  - 在相似度计算中增加颜色权重
  - 在属性验证中强制颜色匹配
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x]* 7.1 编写属性测试：颜色信息提取
  - **属性 11：颜色信息提取**
  - **验证：需求 5.1**
  - 生成包含颜色词汇的产品名称
  - 验证颜色被正确提取
  - 标签：`Feature: smart-match-optimization, Property 11: 颜色信息提取`

- [x]* 7.2 编写属性测试：颜色同义词等价性
  - **属性 12：颜色同义词等价性**
  - **验证：需求 5.3**
  - 生成包含颜色同义词的产品对
  - 验证同义词被视为等价
  - 标签：`Feature: smart-match-optimization, Property 12: 颜色同义词等价性`

- [x]* 7.3 编写属性测试：颜色匹配必要性
  - **属性 13：颜色匹配必要性**
  - **验证：需求 5.2, 5.4**
  - 生成都包含颜色的产品对（颜色匹配/不匹配）
  - 验证颜色不匹配导致分数降低或匹配失败
  - 标签：`Feature: smart-match-optimization, Property 13: 颜色匹配必要性`

- [ ] 8. 实现动态阈值调整
  - 在 `MatchingService` 中实现 `getThreshold()` 方法
  - 根据产品类型返回不同阈值（手表0.72、手机0.70、平板0.65、笔记本0.68、配件0.60）
  - 根据匹配字段调整阈值（SKU名称+0.05、SPU名称-0.05）
  - 在 `smartMatch()` 方法中使用动态阈值
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x]* 8.1 编写属性测试：产品类型阈值差异性
  - **属性 14：产品类型阈值差异性**
  - **验证：需求 6.1**
  - 生成不同产品类型
  - 验证使用不同阈值
  - 标签：`Feature: smart-match-optimization, Property 14: 产品类型阈值差异性`

- [x]* 8.2 编写属性测试：字段类型阈值调整
  - **属性 15：字段类型阈值调整**
  - **验证：需求 6.4, 6.5**
  - 生成不同字段类型的匹配操作
  - 验证SKU名称阈值高于SPU名称阈值
  - 标签：`Feature: smart-match-optimization, Property 15: 字段类型阈值调整`

- [ ] 9. 增强属性验证逻辑
  - 改进 `validateMatchAttributes()` 方法
  - 添加版本标识验证
  - 增强颜色验证（必须匹配）
  - 增强容量验证（处理RAM+ROM格式）
  - 记录验证失败原因
  - 在验证失败时显著降低相似度分数
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [x]* 9.1 编写属性测试：关键属性验证完整性
  - **属性 16：关键属性验证完整性**
  - **验证：需求 7.1, 7.2, 7.3, 7.4, 7.5, 7.6**
  - 生成随机产品对（属性匹配/不匹配）
  - 验证所有关键属性被验证
  - 验证属性不匹配时分数降低或候选项被拒绝
  - 标签：`Feature: smart-match-optimization, Property 16: 关键属性验证完整性`

- [ ] 10. 检查点 - 确保所有增强功能测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 11. 添加日志和可追溯性
  - 在匹配过程中记录详细信息（输入提取、候选提取、相似度计算、验证结果）
  - 在控制台输出前3行的详细匹配日志
  - 每处理100行显示一次进度信息
  - 在匹配完成后显示总耗时和匹配成功率
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

- [ ] 12. 性能优化
  - 确保使用索引结构加速候选项查找
  - 确保使用品牌过滤减少候选项数量
  - 优化循环和数据结构
  - 测试大批量数据处理（1000行）
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 13. 回归测试 - 验证40个真实错误案例
  - 创建测试文件，包含40个真实错误案例
  - 运行匹配算法，记录结果
  - 验证至少95%的匹配准确率（38/40）
  - 分析失败案例，必要时调整算法
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 14. 最终检查点 - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行回归测试
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
